@model IEnumerable<Dat_Ve_Xem_Phim_CGV.Models.HOADON>
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="h-full overflow-y-auto p-6 custom-scrollbar">
    @if (TempData["Success"] != null)
    {
        <div class="alert-message mb-4 p-4 bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 rounded-xl flex items-center gap-3">
            <span class="material-symbols-outlined">check_circle</span> @TempData["Success"]
        </div>
    }

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">Lịch sử đặt vé</h1>
        <div class="bg-surface-highlight/30 px-4 py-2 rounded-lg border border-white/10">
            <span class="text-slate-400">Tổng doanh thu:</span>
            <span class="text-primary font-bold ml-2">
                @((Model != null && Model.Any()) ? Model.Sum(x => x.THANHTIEN ?? 0).ToString("N0") : "0") VNĐ
            </span>
        </div>
    </div>

    <div class="bg-surface-dark rounded-2xl border border-surface-highlight overflow-hidden shadow-2xl">
        <table class="w-full text-left text-sm">
            <thead class="bg-surface-highlight/50 text-slate-300 uppercase text-xs font-bold">
                <tr>
                    <th class="px-6 py-4">Mã HĐ</th>
                    <th class="px-6 py-4">Khách hàng</th>
                    <th class="px-6 py-4">Ngày đặt</th>
                    <th class="px-6 py-4">Tổng tiền</th>
                    <th class="px-6 py-4 text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-surface-highlight text-slate-300">
                @foreach (var item in Model)
                {
                    <tr class="hover:bg-white/[0.02] transition-colors">
                        <td class="px-6 py-4 font-mono text-primary">@item.MAHD</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-white">@item.KHACHHANG.HOTEN</div>
                            <div class="text-xs text-slate-500">@item.KHACHHANG.SDT</div>
                        </td>
                        <td class="px-6 py-4">@item.NGAYGD.Value.ToString("dd/MM/yyyy HH:mm")</td>
                        <td class="px-6 py-4 text-emerald-400 font-bold">@item.THANHTIEN.Value.ToString("N0") đ</td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center gap-3">
                                <button onclick="viewDetail('@item.MAHD')" class="p-2 bg-blue-500/10 text-blue-400 rounded-lg hover:bg-blue-500 hover:text-white transition-all">
                                    <span class="material-symbols-outlined">visibility</span>
                                </button>
                                <button onclick="confirmHuyVe('@item.MAHD')" class="p-2 bg-rose-500/10 text-rose-400 rounded-lg hover:bg-rose-500 hover:text-white transition-all">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div id="detailModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div class="bg-surface-dark border border-white/10 w-full max-w-2xl rounded-3xl overflow-hidden shadow-2xl">
        <div class="p-6 border-b border-surface-highlight flex justify-between items-center">
            <h3 class="text-xl font-bold text-white">Chi tiết vé đặt</h3>
            <button onclick="closeDetailModal()" class="text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="detailContent" class="space-y-4">
            </div>
        </div>
    </div>
</div>

<script>
    function viewDetail(maHD) {
        const content = document.getElementById('detailContent');
        content.innerHTML = '<div class="text-center py-10"><span class="animate-spin material-symbols-outlined text-primary">sync</span> Đang tải...</div>';
        document.getElementById('detailModal').classList.remove('hidden');

        fetch('/Admin/GetDetailVe?maHD=' + maHD)
            .then(res => res.json())
            .then(data => {
                if (!data || data.length === 0) {
                    content.innerHTML = '<div class="text-center py-10 text-slate-400">Không tìm thấy chi tiết vé.</div>';
                    return;
                }

                let html = `
                <div class="grid grid-cols-2 gap-4 mb-6 pb-4 border-b border-white/10">
                    <div class="text-slate-400 text-sm">Phim: <br/><span class="text-white font-bold text-base">${data[0].TenPhim}</span></div>
                    <div class="text-slate-400 text-sm text-right">Suất chiếu: <br/><span class="text-white font-bold text-base">${data[0].GioChieu} | ${data[0].NgayChieu}</span></div>
                </div>
                <table class="w-full">
                    <thead class="text-slate-500 uppercase text-[11px] font-bold tracking-wider">
                        <tr>
                            <th class="text-left pb-3 w-1/3">Mã Vé</th>
                            <th class="text-center pb-3 w-1/3">Vị trí Ghế</th>
                            <th class="text-right pb-3 w-1/3">Giá vé</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">`;

                data.forEach(v => {
                    html += `
                    <tr class="group">
                        <td class="py-4 font-mono text-primary text-sm">${v.MaVe}</td>
                        <td class="py-4 text-white font-bold text-center">
                            <span class="bg-white/5 px-3 py-1 rounded-md border border-white/10 group-hover:bg-primary/20 transition-colors">
                                ${v.TenGhe}
                            </span>
                        </td>
                        <td class="py-4 text-right text-emerald-400 font-semibold">
                            ${v.GiaVe.toLocaleString()} đ
                        </td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                content.innerHTML = html;
            })
            .catch(err => {
                content.innerHTML = '<div class="text-center py-10 text-rose-400">Có lỗi xảy ra khi tải dữ liệu.</div>';
            });
    }

    function closeDetailModal() {
        document.getElementById('detailModal').classList.add('hidden');
    }

    function confirmHuyVe(maHD) {
        if (confirm("Xác nhận hủy hóa đơn này? Mọi vé liên quan sẽ bị xóa và ghế sẽ được giải phóng!")) {
            window.location.href = '/Admin/HuyHoaDon/' + maHD;
        }
    }

    // Logic ẩn thông báo sau 5s (Dùng chung cho cả web)
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert-message');
        alerts.forEach(a => a.classList.add('opacity-0', '-translate-y-4', 'transition-all', 'duration-500'));
        setTimeout(() => alerts.forEach(a => a.remove()), 500);
    }, 5000);
</script>